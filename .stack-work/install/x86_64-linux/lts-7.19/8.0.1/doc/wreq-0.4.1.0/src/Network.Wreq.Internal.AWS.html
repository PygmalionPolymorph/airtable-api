<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE OverloadedStrings, BangPatterns #-}</span><span>
</span><a name="line-2"></a><span class="hs-pragma">{-# OPTIONS_GHC -fno-warn-orphans #-}</span><span>
</span><a name="line-3"></a><span>
</span><a name="line-4"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Network</span><span class="hs-operator">.</span><span class="hs-identifier">Wreq</span><span class="hs-operator">.</span><span class="hs-identifier">Internal</span><span class="hs-operator">.</span><span class="hs-identifier">AWS</span><span>
</span><a name="line-5"></a><span>    </span><span class="hs-special">(</span><span>
</span><a name="line-6"></a><span>      </span><a href="Network.Wreq.Internal.AWS.html#signRequest"><span class="hs-identifier hs-var">signRequest</span></a><span>
</span><a name="line-7"></a><span>    </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-8"></a><span>
</span><a name="line-9"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Applicative</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-operator hs-var">&lt;$&gt;</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-10"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Lens</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-operator hs-var">%~</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">^.</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">&amp;</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">to</span><span class="hs-special">)</span><span>
</span><a name="line-11"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Crypto</span><span class="hs-operator">.</span><span class="hs-identifier">MAC</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">hmac</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">hmacGetDigest</span><span class="hs-special">)</span><span>
</span><a name="line-12"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">ByteString</span><span class="hs-operator">.</span><span class="hs-identifier">Base16</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">HEX</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">encode</span><span class="hs-special">)</span><span>
</span><a name="line-13"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Byteable</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">toBytes</span><span class="hs-special">)</span><span>
</span><a name="line-14"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Char</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">toLower</span><span class="hs-special">)</span><span>
</span><a name="line-15"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">List</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">sort</span><span class="hs-special">)</span><span>
</span><a name="line-16"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Monoid</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-operator hs-var">&lt;&gt;</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-17"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Time</span><span class="hs-operator">.</span><span class="hs-identifier">Clock</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">getCurrentTime</span><span class="hs-special">)</span><span>
</span><a name="line-18"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Time</span><span class="hs-operator">.</span><span class="hs-identifier">Format</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">formatTime</span><span class="hs-special">)</span><span>
</span><a name="line-19"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Time</span><span class="hs-operator">.</span><span class="hs-identifier">Locale</span><span class="hs-operator">.</span><span class="hs-identifier">Compat</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">defaultTimeLocale</span><span class="hs-special">)</span><span>
</span><a name="line-20"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Time</span><span class="hs-operator">.</span><span class="hs-identifier">LocalTime</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">utc</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">utcToLocalTime</span><span class="hs-special">)</span><span>
</span><a name="line-21"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Network</span><span class="hs-operator">.</span><span class="hs-identifier">HTTP</span><span class="hs-operator">.</span><span class="hs-identifier">Types</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">parseSimpleQuery</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">urlEncode</span><span class="hs-special">)</span><span>
</span><a name="line-22"></a><span class="hs-keyword">import</span><span> </span><a href="Network.Wreq.Internal.Lens.html"><span class="hs-identifier">Network</span><span class="hs-operator">.</span><span class="hs-identifier">Wreq</span><span class="hs-operator">.</span><span class="hs-identifier">Internal</span><span class="hs-operator">.</span><span class="hs-identifier">Lens</span></a><span>
</span><a name="line-23"></a><span class="hs-keyword">import</span><span> </span><a href="Network.Wreq.Internal.Types.html"><span class="hs-identifier">Network</span><span class="hs-operator">.</span><span class="hs-identifier">Wreq</span><span class="hs-operator">.</span><span class="hs-identifier">Internal</span><span class="hs-operator">.</span><span class="hs-identifier">Types</span></a><span> </span><span class="hs-special">(</span><a href="Network.Wreq.Internal.Types.html#AWSAuthVersion"><span class="hs-identifier hs-type">AWSAuthVersion</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-24"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Crypto</span><span class="hs-operator">.</span><span class="hs-identifier">Hash</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">CT</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">HMAC</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">SHA256</span><span class="hs-special">)</span><span>
</span><a name="line-25"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Crypto</span><span class="hs-operator">.</span><span class="hs-identifier">Hash</span><span class="hs-operator">.</span><span class="hs-identifier">SHA256</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">SHA256</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">hash</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">hashlazy</span><span class="hs-special">)</span><span>
</span><a name="line-26"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">ByteString</span><span class="hs-operator">.</span><span class="hs-identifier">Char8</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">S</span><span>
</span><a name="line-27"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">CaseInsensitive</span><span>  </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">CI</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">original</span><span class="hs-special">)</span><span>
</span><a name="line-28"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">HashSet</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">HashSet</span><span>
</span><a name="line-29"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Network</span><span class="hs-operator">.</span><span class="hs-identifier">HTTP</span><span class="hs-operator">.</span><span class="hs-identifier">Client</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">HTTP</span><span>
</span><a name="line-30"></a><span>
</span><a name="line-31"></a><span class="hs-comment">-- Sign requests following the AWS v4 request signing specification:</span><span>
</span><a name="line-32"></a><span class="hs-comment">-- http://docs.aws.amazon.com/general/latest/gr/sigv4-create-canonical-request.html</span><span>
</span><a name="line-33"></a><span class="hs-comment">--</span><span>
</span><a name="line-34"></a><span class="hs-comment">-- Runscope Inc. Traffic Inspector support:</span><span>
</span><a name="line-35"></a><span class="hs-comment">-- We support (optionally) sending requests through the Runscope</span><span>
</span><a name="line-36"></a><span class="hs-comment">-- (http://www.runscope.com) Traffic Inspector. If given a Runscope</span><span>
</span><a name="line-37"></a><span class="hs-comment">-- URL to an AWS service, we will extract and correctly sign the</span><span>
</span><a name="line-38"></a><span class="hs-comment">-- request for the underlying AWS service. We support Runscope buckets</span><span>
</span><a name="line-39"></a><span class="hs-comment">-- with and without Bucket Authorization enabled</span><span>
</span><a name="line-40"></a><span class="hs-comment">-- (&quot;Runscope-Bucket-Auth&quot;).</span><span>
</span><a name="line-41"></a><span class="hs-comment">--</span><span>
</span><a name="line-42"></a><span class="hs-comment">-- TODO: adjust when DELETE supports a body or PATCH is added</span><span>
</span><a name="line-43"></a><span class="hs-identifier">signRequest</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Network.Wreq.Internal.Types.html#AWSAuthVersion"><span class="hs-identifier hs-type">AWSAuthVersion</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">S</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">ByteString</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">S</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">ByteString</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-44"></a><span>               </span><span class="hs-identifier hs-type">Request</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-identifier hs-type">Request</span><span>
</span><a name="line-45"></a><a name="signRequest"><a href="Network.Wreq.Internal.AWS.html#signRequest"><span class="hs-identifier">signRequest</span></a></a><span> </span><a href="Network.Wreq.Internal.Types.html#AWSv4"><span class="hs-identifier hs-var">AWSv4</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Network.Wreq.Internal.AWS.html#signRequestV4"><span class="hs-identifier hs-var">signRequestV4</span></a><span>
</span><a name="line-46"></a><span>
</span><a name="line-47"></a><span class="hs-identifier">signRequestV4</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">S</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">ByteString</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">S</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">ByteString</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Request</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-identifier hs-type">Request</span><span>
</span><a name="line-48"></a><a name="signRequestV4"><a href="Network.Wreq.Internal.AWS.html#signRequestV4"><span class="hs-identifier">signRequestV4</span></a></a><span> </span><a name="local-1627557627"><a href="#local-1627557627"><span class="hs-identifier">key</span></a></a><span> </span><a name="local-1627557628"><a href="#local-1627557628"><span class="hs-identifier">secret</span></a></a><span> </span><a name="local-1627557629"><a href="#local-1627557629"><span class="hs-identifier">request</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-49"></a><span>  </span><span class="hs-glyph">!</span><a name="local-1627558205"><a href="#local-1627558205"><span class="hs-identifier">ts</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-1627557632"><span class="hs-identifier hs-var">timestamp</span></a><span>                         </span><span class="hs-comment">-- YYYYMMDDT242424Z, UTC based</span><span>
</span><a name="line-50"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-1627558206"><a href="#local-1627558206"><span class="hs-identifier">origHost</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627557629"><span class="hs-identifier hs-var">request</span></a><span> </span><span class="hs-operator hs-var">^.</span><span> </span><a href="Network.Wreq.Internal.Lens.html#host"><span class="hs-identifier hs-var">host</span></a><span>          </span><span class="hs-comment">-- potentially w/ runscope bucket</span><span>
</span><a name="line-51"></a><span>      </span><a name="local-1627558207"><a href="#local-1627558207"><span class="hs-identifier">runscopeBucketAuth</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-52"></a><span>        </span><span class="hs-identifier hs-var">lookup</span><span> </span><span class="hs-string">&quot;Runscope-Bucket-Auth&quot;</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-1627557629"><span class="hs-identifier hs-var">request</span></a><span> </span><span class="hs-operator hs-var">^.</span><span> </span><a href="Network.Wreq.Internal.Lens.html#requestHeaders"><span class="hs-identifier hs-var">requestHeaders</span></a><span>
</span><a name="line-53"></a><span>      </span><a name="local-1627558208"><a href="#local-1627558208"><span class="hs-identifier">noRunscopeHost</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Network.Wreq.Internal.AWS.html#removeRunscope"><span class="hs-identifier hs-var">removeRunscope</span></a><span> </span><a href="#local-1627558206"><span class="hs-identifier hs-var">origHost</span></a><span> </span><span class="hs-comment">-- rm Runscope for signing</span><span>
</span><a name="line-54"></a><span>      </span><span class="hs-special">(</span><a name="local-1627558209"><a href="#local-1627558209"><span class="hs-identifier">service</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627558210"><a href="#local-1627558210"><span class="hs-identifier">region</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Network.Wreq.Internal.AWS.html#serviceAndRegion"><span class="hs-identifier hs-var">serviceAndRegion</span></a><span> </span><a href="#local-1627558208"><span class="hs-identifier hs-var">noRunscopeHost</span></a><span>
</span><a name="line-55"></a><span>      </span><a name="local-1627558211"><a href="#local-1627558211"><span class="hs-identifier">date</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">S</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">takeWhile</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">/=</span><span> </span><span class="hs-char">'T'</span><span class="hs-special">)</span><span> </span><a href="#local-1627558205"><span class="hs-identifier hs-var">ts</span></a><span>      </span><span class="hs-comment">-- YYYYMMDD</span><span>
</span><a name="line-56"></a><span>      </span><a name="local-1627558212"><a href="#local-1627558212"><span class="hs-identifier">hashedPayload</span></a></a><span>
</span><a name="line-57"></a><span>        </span><span class="hs-glyph">|</span><span> </span><a href="#local-1627557629"><span class="hs-identifier hs-var">request</span></a><span> </span><span class="hs-operator hs-var">^.</span><span> </span><a href="Network.Wreq.Internal.Lens.html#method"><span class="hs-identifier hs-var">method</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">elem</span><span class="hs-special">`</span><span> </span><span class="hs-special">[</span><span class="hs-string">&quot;POST&quot;</span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;PUT&quot;</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Network.Wreq.Internal.AWS.html#payloadHash"><span class="hs-identifier hs-var">payloadHash</span></a><span> </span><a href="#local-1627558213"><span class="hs-identifier hs-var">req</span></a><span>
</span><a name="line-58"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">HEX</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">encode</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">SHA256</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">hash</span><span> </span><span class="hs-string">&quot;&quot;</span><span>
</span><a name="line-59"></a><span>      </span><span class="hs-comment">-- add common v4 signing headers, service specific headers, and</span><span>
</span><a name="line-60"></a><span>      </span><span class="hs-comment">-- drop tmp header and Runscope-Bucket-Auth header (if present).</span><span>
</span><a name="line-61"></a><span>      </span><a name="local-1627558213"><a href="#local-1627558213"><span class="hs-identifier">req</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627557629"><span class="hs-identifier hs-var">request</span></a><span> </span><span class="hs-operator hs-var">&amp;</span><span> </span><a href="Network.Wreq.Internal.Lens.html#requestHeaders"><span class="hs-identifier hs-var">requestHeaders</span></a><span> </span><span class="hs-operator hs-var">%~</span><span>
</span><a name="line-62"></a><span>            </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;host&quot;</span><span class="hs-special">,</span><span> </span><a href="#local-1627558208"><span class="hs-identifier hs-var">noRunscopeHost</span></a><span class="hs-special">)</span><span>
</span><a name="line-63"></a><span>              </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;x-amz-date&quot;</span><span class="hs-special">,</span><span> </span><a href="#local-1627558205"><span class="hs-identifier hs-var">ts</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-operator hs-var">++</span><span>
</span><a name="line-64"></a><span>              </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-string">&quot;x-amz-content-sha256&quot;</span><span class="hs-special">,</span><span> </span><a href="#local-1627558212"><span class="hs-identifier hs-var">hashedPayload</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-1627558209"><span class="hs-identifier hs-var">service</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-string">&quot;s3&quot;</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">++</span><span class="hs-special">)</span><span>
</span><a name="line-65"></a><span>            </span><span class="hs-comment">-- Runscope (correctly) doesn't send Bucket Auth header to AWS,</span><span>
</span><a name="line-66"></a><span>            </span><span class="hs-comment">-- remove it from the headers we sign. Adding back in at the end.</span><span>
</span><a name="line-67"></a><span>            </span><span class="hs-operator hs-var">.</span><span> </span><a href="Network.Wreq.Internal.Lens.html#deleteKey"><span class="hs-identifier hs-var">deleteKey</span></a><span> </span><span class="hs-string">&quot;Runscope-Bucket-Auth&quot;</span><span>
</span><a name="line-68"></a><span>  </span><span class="hs-comment">-- task 1</span><span>
</span><a name="line-69"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-1627558242"><a href="#local-1627558242"><span class="hs-identifier">hl</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627558213"><span class="hs-identifier hs-var">req</span></a><span> </span><span class="hs-operator hs-var">^.</span><span> </span><a href="Network.Wreq.Internal.Lens.html#requestHeaders"><span class="hs-identifier hs-var">requestHeaders</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">to</span><span> </span><span class="hs-identifier hs-var">sort</span><span>
</span><a name="line-70"></a><span>      </span><a name="local-1627558243"><a href="#local-1627558243"><span class="hs-identifier">signedHeaders</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">S</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">intercalate</span><span> </span><span class="hs-string">&quot;;&quot;</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><a href="#local-1627557630"><span class="hs-identifier hs-var">lowerCI</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">fst</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-1627558242"><span class="hs-identifier hs-var">hl</span></a><span>
</span><a name="line-71"></a><span>      </span><a name="local-1627558244"><a href="#local-1627558244"><span class="hs-identifier">canonicalReq</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">S</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">intercalate</span><span> </span><span class="hs-string">&quot;\n&quot;</span><span> </span><span class="hs-special">[</span><span>
</span><a name="line-72"></a><span>          </span><a href="#local-1627558213"><span class="hs-identifier hs-var">req</span></a><span> </span><span class="hs-operator hs-var">^.</span><span> </span><a href="Network.Wreq.Internal.Lens.html#method"><span class="hs-identifier hs-var">method</span></a><span>             </span><span class="hs-comment">-- step 1</span><span>
</span><a name="line-73"></a><span>        </span><span class="hs-special">,</span><span> </span><a href="#local-1627558213"><span class="hs-identifier hs-var">req</span></a><span> </span><span class="hs-operator hs-var">^.</span><span> </span><a href="Network.Wreq.Internal.Lens.html#path"><span class="hs-identifier hs-var">path</span></a><span>               </span><span class="hs-comment">-- step 2</span><span>
</span><a name="line-74"></a><span>        </span><span class="hs-special">,</span><span>   </span><span class="hs-identifier hs-var">S</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">intercalate</span><span> </span><span class="hs-string">&quot;&amp;&quot;</span><span>       </span><span class="hs-comment">-- step 3b, incl. sort</span><span>
</span><a name="line-75"></a><span>            </span><span class="hs-comment">-- urlEncode True (QS) to encode ':' and '/' (e.g. in AWS arns)</span><span>
</span><a name="line-76"></a><span>          </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><a name="local-1627558245"><a href="#local-1627558245"><span class="hs-identifier">k</span></a></a><span class="hs-special">,</span><a name="local-1627558246"><a href="#local-1627558246"><span class="hs-identifier">v</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">urlEncode</span><span> </span><span class="hs-identifier hs-var">True</span><span> </span><a href="#local-1627558245"><span class="hs-identifier hs-var">k</span></a><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-string">&quot;=&quot;</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">urlEncode</span><span> </span><span class="hs-identifier hs-var">True</span><span> </span><a href="#local-1627558246"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">)</span><span>
</span><a name="line-77"></a><span>          </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">sort</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-78"></a><span>          </span><span class="hs-identifier hs-var">parseSimpleQuery</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-1627558213"><span class="hs-identifier hs-var">req</span></a><span> </span><span class="hs-operator hs-var">^.</span><span> </span><a href="Network.Wreq.Internal.Lens.html#queryString"><span class="hs-identifier hs-var">queryString</span></a><span>
</span><a name="line-79"></a><span>        </span><span class="hs-special">,</span><span>   </span><span class="hs-identifier hs-var">S</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">unlines</span><span>                </span><span class="hs-comment">-- step 4, incl. sort</span><span>
</span><a name="line-80"></a><span>          </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><a name="local-1627558326"><a href="#local-1627558326"><span class="hs-identifier">k</span></a></a><span class="hs-special">,</span><a name="local-1627558327"><a href="#local-1627558327"><span class="hs-identifier">v</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-1627557630"><span class="hs-identifier hs-var">lowerCI</span></a><span> </span><a href="#local-1627558326"><span class="hs-identifier hs-var">k</span></a><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-string">&quot;:&quot;</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><a href="#local-1627557631"><span class="hs-identifier hs-var">trimHeaderValue</span></a><span> </span><a href="#local-1627558327"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-1627558242"><span class="hs-identifier hs-var">hl</span></a><span>
</span><a name="line-81"></a><span>        </span><span class="hs-special">,</span><span> </span><a href="#local-1627558243"><span class="hs-identifier hs-var">signedHeaders</span></a><span>             </span><span class="hs-comment">-- step 5</span><span>
</span><a name="line-82"></a><span>        </span><span class="hs-special">,</span><span> </span><a href="#local-1627558212"><span class="hs-identifier hs-var">hashedPayload</span></a><span>             </span><span class="hs-comment">-- step 6, handles empty payload</span><span>
</span><a name="line-83"></a><span>        </span><span class="hs-special">]</span><span>
</span><a name="line-84"></a><span>  </span><span class="hs-comment">-- task 2</span><span>
</span><a name="line-85"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-1627558328"><a href="#local-1627558328"><span class="hs-identifier">dateScope</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">S</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">intercalate</span><span> </span><span class="hs-string">&quot;/&quot;</span><span> </span><span class="hs-special">[</span><a href="#local-1627558211"><span class="hs-identifier hs-var">date</span></a><span class="hs-special">,</span><span> </span><a href="#local-1627558210"><span class="hs-identifier hs-var">region</span></a><span class="hs-special">,</span><span> </span><a href="#local-1627558209"><span class="hs-identifier hs-var">service</span></a><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;aws4_request&quot;</span><span class="hs-special">]</span><span>
</span><a name="line-86"></a><span>      </span><a name="local-1627558329"><a href="#local-1627558329"><span class="hs-identifier">stringToSign</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">S</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">intercalate</span><span> </span><span class="hs-string">&quot;\n&quot;</span><span> </span><span class="hs-special">[</span><span>
</span><a name="line-87"></a><span>          </span><span class="hs-string">&quot;AWS4-HMAC-SHA256&quot;</span><span>
</span><a name="line-88"></a><span>        </span><span class="hs-special">,</span><span> </span><a href="#local-1627558205"><span class="hs-identifier hs-var">ts</span></a><span>
</span><a name="line-89"></a><span>        </span><span class="hs-special">,</span><span> </span><a href="#local-1627558328"><span class="hs-identifier hs-var">dateScope</span></a><span>
</span><a name="line-90"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">HEX</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">encode</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">SHA256</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">hash</span><span> </span><a href="#local-1627558244"><span class="hs-identifier hs-var">canonicalReq</span></a><span>
</span><a name="line-91"></a><span>        </span><span class="hs-special">]</span><span>
</span><a name="line-92"></a><span>  </span><span class="hs-comment">-- task 3, steps 1 and 2</span><span>
</span><a name="line-93"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-1627558330"><a href="#local-1627558330"><span class="hs-identifier">signature</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;AWS4&quot;</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><a href="#local-1627557628"><span class="hs-identifier hs-var">secret</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&amp;</span><span>
</span><a name="line-94"></a><span>                  </span><a href="#local-1627557633"><span class="hs-identifier hs-var">hmac'</span></a><span> </span><a href="#local-1627558211"><span class="hs-identifier hs-var">date</span></a><span> </span><span class="hs-operator hs-var">&amp;</span><span> </span><a href="#local-1627557633"><span class="hs-identifier hs-var">hmac'</span></a><span> </span><a href="#local-1627558210"><span class="hs-identifier hs-var">region</span></a><span> </span><span class="hs-operator hs-var">&amp;</span><span> </span><a href="#local-1627557633"><span class="hs-identifier hs-var">hmac'</span></a><span> </span><a href="#local-1627558209"><span class="hs-identifier hs-var">service</span></a><span> </span><span class="hs-operator hs-var">&amp;</span><span>
</span><a name="line-95"></a><span>                  </span><a href="#local-1627557633"><span class="hs-identifier hs-var">hmac'</span></a><span> </span><span class="hs-string">&quot;aws4_request&quot;</span><span> </span><span class="hs-operator hs-var">&amp;</span><span> </span><a href="#local-1627557633"><span class="hs-identifier hs-var">hmac'</span></a><span> </span><a href="#local-1627558329"><span class="hs-identifier hs-var">stringToSign</span></a><span> </span><span class="hs-operator hs-var">&amp;</span><span> </span><span class="hs-identifier hs-var">HEX</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">encode</span><span>
</span><a name="line-96"></a><span>      </span><a name="local-1627558331"><a href="#local-1627558331"><span class="hs-identifier">authorization</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">S</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">intercalate</span><span> </span><span class="hs-string">&quot;, &quot;</span><span> </span><span class="hs-special">[</span><span>
</span><a name="line-97"></a><span>          </span><span class="hs-string">&quot;AWS4-HMAC-SHA256 Credential=&quot;</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><a href="#local-1627557627"><span class="hs-identifier hs-var">key</span></a><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-string">&quot;/&quot;</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><a href="#local-1627558328"><span class="hs-identifier hs-var">dateScope</span></a><span>
</span><a name="line-98"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;SignedHeaders=&quot;</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><a href="#local-1627558243"><span class="hs-identifier hs-var">signedHeaders</span></a><span>
</span><a name="line-99"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;Signature=&quot;</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><a href="#local-1627558330"><span class="hs-identifier hs-var">signature</span></a><span>
</span><a name="line-100"></a><span>        </span><span class="hs-special">]</span><span>
</span><a name="line-101"></a><span>  </span><span class="hs-comment">-- Add the AWS Authorization header.</span><span>
</span><a name="line-102"></a><span>  </span><span class="hs-comment">-- Restore the Host header to the Runscope endpoint</span><span>
</span><a name="line-103"></a><span>  </span><span class="hs-comment">-- so they can proxy accordingly (if used, otherwise this is a nop).</span><span>
</span><a name="line-104"></a><span>  </span><span class="hs-comment">-- Add the Runscope Bucket Auth header back in, if it was set originally.</span><span>
</span><a name="line-105"></a><span>  </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Network.Wreq.Internal.Lens.html#setHeader"><span class="hs-identifier hs-var">setHeader</span></a><span> </span><span class="hs-string">&quot;host&quot;</span><span> </span><a href="#local-1627558206"><span class="hs-identifier hs-var">origHost</span></a><span>
</span><a name="line-106"></a><span>        </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-identifier hs-var">maybe</span><span> </span><span class="hs-identifier hs-var">id</span><span> </span><span class="hs-special">(</span><a href="Network.Wreq.Internal.Lens.html#setHeader"><span class="hs-identifier hs-var">setHeader</span></a><span> </span><span class="hs-string">&quot;Runscope-Bucket-Auth&quot;</span><span class="hs-special">)</span><span> </span><a href="#local-1627558207"><span class="hs-identifier hs-var">runscopeBucketAuth</span></a><span>
</span><a name="line-107"></a><span>        </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="Network.Wreq.Internal.Lens.html#setHeader"><span class="hs-identifier hs-var">setHeader</span></a><span> </span><span class="hs-string">&quot;authorization&quot;</span><span> </span><a href="#local-1627558331"><span class="hs-identifier hs-var">authorization</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-1627558213"><span class="hs-identifier hs-var">req</span></a><span>
</span><a name="line-108"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-109"></a><span>    </span><a name="local-1627557630"><a href="#local-1627557630"><span class="hs-identifier">lowerCI</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">S</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">toLower</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">CI</span><span class="hs-operator">.</span><span class="hs-identifier">original</span><span>
</span><a name="line-110"></a><span>    </span><a name="local-1627557631"><a href="#local-1627557631"><span class="hs-identifier">trimHeaderValue</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-111"></a><span>      </span><span class="hs-identifier hs-var">id</span><span> </span><span class="hs-comment">-- FIXME, see step 4, whitespace trimming but not in double</span><span>
</span><a name="line-112"></a><span>         </span><span class="hs-comment">-- quoted sections, AWS spec.</span><span>
</span><a name="line-113"></a><span>    </span><a name="local-1627557632"><a href="#local-1627557632"><span class="hs-identifier">timestamp</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627557634"><span class="hs-identifier hs-var">render</span></a><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-identifier hs-var">getCurrentTime</span><span>
</span><a name="line-114"></a><span>      </span><span class="hs-keyword">where</span><span> </span><a name="local-1627557634"><a href="#local-1627557634"><span class="hs-identifier">render</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">S</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">pack</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">formatTime</span><span> </span><span class="hs-identifier hs-var">defaultTimeLocale</span><span> </span><span class="hs-string">&quot;%Y%m%dT%H%M%SZ&quot;</span><span> </span><span class="hs-operator hs-var">.</span><span>
</span><a name="line-115"></a><span>                     </span><span class="hs-identifier hs-var">utcToLocalTime</span><span> </span><span class="hs-identifier hs-var">utc</span><span> </span><span class="hs-comment">-- UTC printable: YYYYMMDDTHHMMSSZ</span><span>
</span><a name="line-116"></a><span>    </span><a name="local-1627557633"><a href="#local-1627557633"><span class="hs-identifier">hmac'</span></a></a><span> </span><a name="local-1627558150"><a href="#local-1627558150"><span class="hs-identifier">s</span></a></a><span> </span><a name="local-1627558151"><a href="#local-1627558151"><span class="hs-identifier">k</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">toBytes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">hmacGetDigest</span><span> </span><a href="#local-1627558152"><span class="hs-identifier hs-var">h</span></a><span class="hs-special">)</span><span>
</span><a name="line-117"></a><span>      </span><span class="hs-keyword">where</span><span> </span><a name="local-1627558152"><a href="#local-1627558152"><span class="hs-identifier">h</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">hmac</span><span> </span><a href="#local-1627558151"><span class="hs-identifier hs-var">k</span></a><span> </span><a href="#local-1627558150"><span class="hs-identifier hs-var">s</span></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">CT</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">HMAC</span><span> </span><span class="hs-identifier hs-type">CT</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">SHA256</span><span class="hs-special">)</span><span>
</span><a name="line-118"></a><span>
</span><a name="line-119"></a><span class="hs-identifier">payloadHash</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Request</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">S</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">ByteString</span><span>
</span><a name="line-120"></a><a name="payloadHash"><a href="Network.Wreq.Internal.AWS.html#payloadHash"><span class="hs-identifier">payloadHash</span></a></a><span> </span><a name="local-1627558353"><a href="#local-1627558353"><span class="hs-identifier">req</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-121"></a><span>  </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier">HTTP</span><span class="hs-operator">.</span><span class="hs-identifier">requestBody</span><span> </span><a href="#local-1627558353"><span class="hs-identifier hs-var">req</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-122"></a><span>    </span><span class="hs-identifier hs-var">HTTP</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">RequestBodyBS</span><span> </span><a name="local-1627558354"><a href="#local-1627558354"><span class="hs-identifier">bs</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-123"></a><span>      </span><span class="hs-identifier hs-var">HEX</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">encode</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">SHA256</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">hash</span><span> </span><a href="#local-1627558354"><span class="hs-identifier hs-var">bs</span></a><span>
</span><a name="line-124"></a><span>    </span><span class="hs-identifier hs-var">HTTP</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">RequestBodyLBS</span><span> </span><a name="local-1627558355"><a href="#local-1627558355"><span class="hs-identifier">lbs</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-125"></a><span>      </span><span class="hs-identifier hs-var">HEX</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">encode</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">SHA256</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">hashlazy</span><span> </span><a href="#local-1627558355"><span class="hs-identifier hs-var">lbs</span></a><span>
</span><a name="line-126"></a><span>    </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">error</span><span> </span><span class="hs-string">&quot;addTmpPayloadHashHeader: unexpected request body type&quot;</span><span>
</span><a name="line-127"></a><span>
</span><a name="line-128"></a><span class="hs-comment">-- Per AWS documentation at:</span><span>
</span><a name="line-129"></a><span class="hs-comment">--   http://docs.aws.amazon.com/general/latest/gr/rande.html</span><span>
</span><a name="line-130"></a><span class="hs-comment">-- For example: &quot;dynamodb.us-east-1.amazonaws.com&quot; -&gt; (&quot;dynamodb&quot;, &quot;us-east-1&quot;)</span><span>
</span><a name="line-131"></a><span class="hs-identifier">serviceAndRegion</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">S</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">ByteString</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">S</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">ByteString</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">S</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">ByteString</span><span class="hs-special">)</span><span>
</span><a name="line-132"></a><a name="serviceAndRegion"><a href="Network.Wreq.Internal.AWS.html#serviceAndRegion"><span class="hs-identifier">serviceAndRegion</span></a></a><span> </span><a name="local-1627558385"><a href="#local-1627558385"><span class="hs-identifier">endpoint</span></a></a><span>
</span><a name="line-133"></a><span>  </span><span class="hs-comment">-- For s3, check &lt;bucket&gt;.s3..., i.e. virtual-host style access</span><span>
</span><a name="line-134"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-string">&quot;.s3.amazonaws.com&quot;</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">S</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">isSuffixOf</span><span class="hs-special">`</span><span> </span><a href="#local-1627558385"><span class="hs-identifier hs-var">endpoint</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- vhost style, classic</span><span>
</span><a name="line-135"></a><span>    </span><span class="hs-special">(</span><span class="hs-string">&quot;s3&quot;</span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;us-east-1&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-136"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-string">&quot;.s3-external-1.amazonaws.com&quot;</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">S</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">isSuffixOf</span><span class="hs-special">`</span><span> </span><a href="#local-1627558385"><span class="hs-identifier hs-var">endpoint</span></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-137"></a><span>    </span><span class="hs-special">(</span><span class="hs-string">&quot;s3&quot;</span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;us-east-1&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-138"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-string">&quot;.s3-&quot;</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">S</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">isInfixOf</span><span class="hs-special">`</span><span> </span><a href="#local-1627558385"><span class="hs-identifier hs-var">endpoint</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- vhost style, regional</span><span>
</span><a name="line-139"></a><span>    </span><span class="hs-special">(</span><span class="hs-string">&quot;s3&quot;</span><span class="hs-special">,</span><span> </span><a href="#local-1627558388"><span class="hs-identifier hs-var">regionInS3VHost</span></a><span> </span><a href="#local-1627558385"><span class="hs-identifier hs-var">endpoint</span></a><span class="hs-special">)</span><span>
</span><a name="line-140"></a><span>  </span><span class="hs-comment">-- For s3, use /&lt;bucket&gt; style access, as opposed to</span><span>
</span><a name="line-141"></a><span>  </span><span class="hs-comment">-- &lt;bucket&gt;.s3... in the hostname.</span><span>
</span><a name="line-142"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-1627558385"><span class="hs-identifier hs-var">endpoint</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">elem</span><span class="hs-special">`</span><span> </span><span class="hs-special">[</span><span class="hs-string">&quot;s3.amazonaws.com&quot;</span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;s3-external-1.amazonaws.com&quot;</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-143"></a><span>    </span><span class="hs-special">(</span><span class="hs-string">&quot;s3&quot;</span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;us-east-1&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-144"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-1627558387"><span class="hs-identifier hs-var">servicePrefix</span></a><span> </span><span class="hs-char">'-'</span><span> </span><a href="#local-1627558385"><span class="hs-identifier hs-var">endpoint</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-string">&quot;s3&quot;</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-145"></a><span>    </span><span class="hs-comment">-- format: e.g. s3-us-west-2.amazonaws.com</span><span>
</span><a name="line-146"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-1627558392"><a href="#local-1627558392"><span class="hs-identifier">region</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">S</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">takeWhile</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">/=</span><span> </span><span class="hs-char">'.'</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">S</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">drop</span><span> </span><span class="hs-number">3</span><span> </span><a href="#local-1627558385"><span class="hs-identifier hs-var">endpoint</span></a><span> </span><span class="hs-comment">-- drop &quot;s3-&quot;</span><span>
</span><a name="line-147"></a><span>    </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;s3&quot;</span><span class="hs-special">,</span><span> </span><a href="#local-1627558392"><span class="hs-identifier hs-var">region</span></a><span class="hs-special">)</span><span>
</span><a name="line-148"></a><span>    </span><span class="hs-comment">-- not s3</span><span>
</span><a name="line-149"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-1627558385"><span class="hs-identifier hs-var">endpoint</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">elem</span><span class="hs-special">`</span><span> </span><span class="hs-special">[</span><span class="hs-string">&quot;sts.amazonaws.com&quot;</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-150"></a><span>    </span><span class="hs-special">(</span><span class="hs-string">&quot;sts&quot;</span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;us-east-1&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-151"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-1627558386"><span class="hs-identifier hs-var">svc</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">HashSet</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">member</span><span class="hs-special">`</span><span> </span><a href="#local-1627558389"><span class="hs-identifier hs-var">noRegion</span></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-152"></a><span>    </span><span class="hs-special">(</span><a href="#local-1627558386"><span class="hs-identifier hs-var">svc</span></a><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;us-east-1&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-153"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-154"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-1627558393"><a href="#local-1627558393"><span class="hs-identifier">service</span></a></a><span class="hs-glyph">:</span><a name="local-1627558394"><a href="#local-1627558394"><span class="hs-identifier">region</span></a></a><span class="hs-glyph">:</span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">S</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">split</span><span> </span><span class="hs-char">'.'</span><span> </span><a href="#local-1627558385"><span class="hs-identifier hs-var">endpoint</span></a><span>
</span><a name="line-155"></a><span>    </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">(</span><a href="#local-1627558393"><span class="hs-identifier hs-var">service</span></a><span class="hs-special">,</span><span> </span><a href="#local-1627558394"><span class="hs-identifier hs-var">region</span></a><span class="hs-special">)</span><span>
</span><a name="line-156"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-157"></a><span>    </span><a name="local-1627558386"><a href="#local-1627558386"><span class="hs-identifier">svc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627558387"><span class="hs-identifier hs-var">servicePrefix</span></a><span> </span><span class="hs-char">'.'</span><span> </span><a href="#local-1627558385"><span class="hs-identifier hs-var">endpoint</span></a><span>
</span><a name="line-158"></a><span>    </span><a name="local-1627558387"><a href="#local-1627558387"><span class="hs-identifier">servicePrefix</span></a></a><span> </span><a name="local-1627558390"><a href="#local-1627558390"><span class="hs-identifier">c</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">S</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">toLower</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">S</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">takeWhile</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">/=</span><span> </span><a href="#local-1627558390"><span class="hs-identifier hs-var">c</span></a><span class="hs-special">)</span><span>
</span><a name="line-159"></a><span>    </span><a name="local-1627558388"><a href="#local-1627558388"><span class="hs-identifier">regionInS3VHost</span></a></a><span> </span><a name="local-1627558391"><a href="#local-1627558391"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-160"></a><span>        </span><span class="hs-identifier hs-var">S</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">takeWhile</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">/=</span><span> </span><span class="hs-char">'.'</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- &quot;eu-west-1&quot;</span><span>
</span><a name="line-161"></a><span>      </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">S</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">reverse</span><span>            </span><span class="hs-comment">-- &quot;eu-west-1.amazonaws.com&quot;</span><span>
</span><a name="line-162"></a><span>      </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">fst</span><span>                  </span><span class="hs-comment">-- &quot;moc.swanozama.1-tsew-ue&quot;</span><span>
</span><a name="line-163"></a><span>      </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">S</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">breakSubstring</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">S</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">pack</span><span> </span><span class="hs-string">&quot;-3s.&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-164"></a><span>      </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">S</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">reverse</span><span>
</span><a name="line-165"></a><span>      </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-1627558391"><span class="hs-identifier hs-var">s</span></a><span>                  </span><span class="hs-comment">-- johnsmith.eu.s3-eu-west-1.amazonaws.com</span><span>
</span><a name="line-166"></a><span>    </span><a name="local-1627558389"><a href="#local-1627558389"><span class="hs-identifier">noRegion</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">HashSet</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">fromList</span><span> </span><span class="hs-special">[</span><span class="hs-string">&quot;iam&quot;</span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;importexport&quot;</span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;route53&quot;</span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;cloudfront&quot;</span><span class="hs-special">]</span><span>
</span><a name="line-167"></a><span>
</span><a name="line-168"></a><span class="hs-comment">-- If the hostname doesn't end in runscope.net, return the original.</span><span>
</span><a name="line-169"></a><span class="hs-comment">-- For a hostname that includes runscope.net:</span><span>
</span><a name="line-170"></a><span class="hs-comment">-- given  sqs-us--east--1-amazonaws-com-&lt;BUCKET&gt;.runscope.net</span><span>
</span><a name="line-171"></a><span class="hs-comment">-- return sqs.us-east-1.amazonaws.com</span><span>
</span><a name="line-172"></a><span class="hs-identifier">removeRunscope</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">S</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">ByteString</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">S</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">ByteString</span><span>
</span><a name="line-173"></a><a name="removeRunscope"><a href="Network.Wreq.Internal.AWS.html#removeRunscope"><span class="hs-identifier">removeRunscope</span></a></a><span> </span><a name="local-1627558395"><a href="#local-1627558395"><span class="hs-identifier">hostname</span></a></a><span>
</span><a name="line-174"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-string">&quot;.runscope.net&quot;</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">S</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">isSuffixOf</span><span class="hs-special">`</span><span> </span><a href="#local-1627558395"><span class="hs-identifier hs-var">hostname</span></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-175"></a><span>    </span><span class="hs-identifier hs-var">S</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">concat</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">Prelude</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><a href="#local-1627558397"><span class="hs-identifier hs-var">p2</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="#local-1627558396"><span class="hs-identifier hs-var">p1</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">S</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">group</span><span> </span><span class="hs-comment">-- decode</span><span>
</span><a name="line-176"></a><span>    </span><span class="hs-comment">-- drop suffix &quot;-&lt;BUCKET&gt;.runscope.net&quot; before decoding</span><span>
</span><a name="line-177"></a><span>    </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">S</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">reverse</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">S</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">tail</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">S</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">dropWhile</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">/=</span><span> </span><span class="hs-char">'-'</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">S</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">reverse</span><span>
</span><a name="line-178"></a><span>    </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-1627558395"><span class="hs-identifier hs-var">hostname</span></a><span>
</span><a name="line-179"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627558395"><span class="hs-identifier hs-var">hostname</span></a><span>
</span><a name="line-180"></a><span>    </span><span class="hs-keyword">where</span><span> </span><a name="local-1627558396"><a href="#local-1627558396"><span class="hs-identifier">p1</span></a></a><span> </span><span class="hs-string">&quot;-&quot;</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-string">&quot;.&quot;</span><span>
</span><a name="line-181"></a><span>          </span><span class="hs-identifier">p1</span><span> </span><a name="local-1627558398"><a href="#local-1627558398"><span class="hs-identifier">other</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627558398"><span class="hs-identifier hs-var">other</span></a><span>
</span><a name="line-182"></a><span>          </span><a name="local-1627558397"><a href="#local-1627558397"><span class="hs-identifier">p2</span></a></a><span> </span><span class="hs-string">&quot;--&quot;</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-string">&quot;-&quot;</span><span>
</span><a name="line-183"></a><span>          </span><span class="hs-identifier">p2</span><span> </span><a name="local-1627558399"><a href="#local-1627558399"><span class="hs-identifier">other</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627558399"><span class="hs-identifier hs-var">other</span></a><span>
</span><a name="line-184"></a></pre></body></html>